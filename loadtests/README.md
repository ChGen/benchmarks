# Artipie performance tests materials

## JMeter notes
* Note that JMeter in Ubuntu 22.04 LTS Linux repository is very old and some modules are missing
* Note that JMeter may go crazy when recording requests from localhost to localhost. One may need to use external IP.
* JMeter HTTP proxy mode recording could be done with GUI only. 
* At the moment we use the following version of JMeter:
`https://dlcdn.apache.org/jmeter/binaries/apache-jmeter-5.5.tgz`

## Datasets

Files adapter tested by files data generated by JMeter inside uploading test. Files downloading test uses list of files stored in the test data directory (`test-data/files-dyn/files-list.csv`).

Maven tests support testing with real artifacts data (`maven-real`) and generated dataset with several configurable parameters of the artifacts (`maven-dyn`). Maven data must be prepared locally by provided scripts.

## Running tests

### 1. Provide symlink to Apache JMeter
```
cd benchmarks/loadtests
ln -s /my/path/to/apache-jmeter-5.5 .
```
### 2. Prepare maven repository test data
```
./prep-maven-real.sh
```
### 3. Prepare maven dynamic test data. See script for the details:
```
time ./prep-maven-dyn.py --groups 3 --artifacts 4 --version 5
```
### 4. Start Artipie container
```
time ./artipie-docker.sh 8081
```
### 5. Run one of the tests. For example:
```
time ./jmx-maven-ul.sh localhost 8081 30 maven-dyn
```

## Test data structure

```
test-data
├── files-dyn                    # artipie files adapter dynamic data test
│   ├── files-list.csv           # list of file names for download testing
│   ├── download-files-csv.jmx
│   └── upload-files.jmx
├── maven-dyn                    # artipie maven adapter dynamic data test
│   ├── files-list.csv
│   └── repository               # generated by prep-maven-dyn.py
└── maven-real                   # artipie maven adapter real-artifacts data test
    ├── files-list.csv
    └── repository               # generated by prep-maven-real.sh
```

## Test scripts

 - `jmeterReport.sh` allows to generate report files for given JMeter jmx file.
 - `prep-maven-real.sh` downloads required maven artifact files for tests. Artifacts put in `test-data/maven-real/repository/`
 - `prep-maven-dyn.py` generates required maven artifact files for tests. Artifacts put in `test-data/maven-dyn/repository/`
 - `jmx-files-maven-ul.sh` upload maven artifacts test set to the files repository adapter (bintest repo)
 - `jmx-files-maven-dl.sh` download maven artifacts test set to the files repository adapter (bintest repo)
 - `jmx-maven-ul.sh` upload maven artifacts test set to the maven repo (maventest repo)
 - `jmx-maven-dl.sh` download maven artifacts test set from the maven repo (maventest repo)
 - `jmx-files-ul.sh` upload random binary data files, like jmx-run.sh
 - `jmx-files-ul.sh` download files by list, generated for upload script above
 - `conan/` some basic scripts for future conan adapter support

## Maven test data generator parameters

Maven test data generator `prep-maven-dyn.py` requires all generator parameters provided for the command line. Here's the usage examples:
```
./prep-maven-dyn.py --total-artifacts 100
./prep-maven-dyn.py --groups 3 --artifacts 4 --versions=5
```

All available generator parameters (available by `--help` key):
```
  --total-artifacts TOTAL_ARTIFACTS  Specify tatal artifacts count. May override groups/artifacts/versions count. (default: None)
  --groups GROUPS           Count of maven groups to generate (default: 3)
  --artifacts ARTIFACTS     Count of maven artifacts to generate (default: 4)
  --versions VERSIONS       Count of maven artifact (sub)versions to generate (default: None)
  --big-size BIG_SIZE       Size of "big" artifact type in bytes (default: 9000000)
  --medium-size MEDIUM_SIZE Size of "medium" artifact type in bytes (default: 192000)
  --small-size SMALL_SIZE   Size of "small" artifact type in bytes (default: 16384)
  --big-p BIG_P             Percent of "big" artifacts (jars) to generate (default: 5)
  --medium-p MEDIUM_P       Percent of "medium" sized artifacts. The rest will be "small" sized. (default: 80)
```

## Downloading via proxy (JMeter)

```
time mvn clean install -Dhttp.proxyHost=localhost -Dhttp.proxyPort=8888 -Dhttps.proxyHost=localhost -Dhttps.proxyPort=8888 -Dmaven.wagon.http.ssl.insecure=true -Dmaven.test.skip -Ddockerfile.skip=true
```
